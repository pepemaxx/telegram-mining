<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>بازی کلیکر تلگرام – ماینینگ ۲۴ ساعته</title>
  <style>
    :root{
      --bg:#f6f7fb; --card:#ffffff; --ink:#0f172a; --muted:#64748b; --border:#e5e7eb;
      --brand:#4f46e5; --brand-50:#eef2ff; --good:#059669; --warn:#f59e0b; --danger:#ef4444;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font-family:IRANSans, Vazirmatn, Segoe UI, Roboto, sans-serif}
    header{position:sticky;top:0;z-index:10;background:rgba(246,247,251,.85);backdrop-filter:blur(8px);border-bottom:1px solid var(--border);padding:12px 16px;display:flex;align-items:center;justify-content:space-between}
    .brand{display:flex;gap:12px;align-items:center}
    .logo{width:36px;height:36px;border-radius:14px;background:linear-gradient(135deg,#6366f1,#a855f7);box-shadow:0 6px 18px rgba(99,102,241,.25)}
    h1{font-size:18px;margin:0}
    .sub{font-size:12px;color:var(--muted)}

    main{max-width:760px;margin:0 auto;padding:16px 16px 110px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:14px 16px;box-shadow:0 6px 18px rgba(15,23,42,.04);margin-top:12px}
    .row{display:flex;align-items:center;justify-content:space-between;gap:12px}
    .muted{color:var(--muted);font-size:12px}
    .big{font-size:28px;font-weight:800}
    .pill{font-size:12px;padding:4px 8px;border-radius:999px;border:1px solid var(--border);background:#f8fafc}
    .pill.good{background:#ecfdf5;color:#065f46;border-color:#d1fae5}
    .pill.warn{background:#fffbeb;color:#92400e;border-color:#fde68a}

    .btn{border:none;border-radius:12px;padding:10px 14px;font-weight:700;cursor:pointer}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .btn-brand{background:var(--brand);color:#fff}
    .btn-gray{background:#e5e7eb;color:#111827}
    .btn-good{background:var(--good);color:#fff}

    .progress{height:10px;border-radius:999px;background:#e7eaf3;overflow:hidden}
    .progress>div{height:100%;background:#6366f1;transition:width .2s}

    .mine-wrap{display:grid;gap:12px}
    .mine-cta{height:60px;font-size:16px}
    #timer{font-weight:800;color:#e11d48;font-size:22px}

    nav.tabs{position:fixed;left:0;right:0;bottom:0;border-top:1px solid var(--border);background:rgba(255,255,255,.92);backdrop-filter:blur(10px)}
    .tabs-inner{max-width:760px;margin:0 auto;height:72px;display:grid;grid-template-columns:repeat(4,1fr)}
    .tab-btn{appearance:none;background:none;border:none;color:#64748b;font-size:14px;display:flex;align-items:center;justify-content:center}
    .tab-btn .pill{background:transparent}
    .tab-btn.active{color:var(--brand)}
    .tab-btn.active .pill{background:var(--brand-50);border-color:#e0e7ff}

    .kicker{color:#111827;font-weight:700}
    .accent{color:#1d4ed8}

    .list{list-style:none;margin:0;padding:0}
    .list li{display:flex;align-items:center;justify-content:space-between;padding:10px 0;border-top:1px solid var(--border)}

    .task{display:flex;align-items:center;justify-content:space-between;gap:8px}
    .task .meta{display:flex;flex-direction:column}
    .task a{color:#1d4ed8;text-decoration:none}

    section.tab{display:none}
    section.tab.active{display:block}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="brand">
        <div class="logo"></div>
        <div>
          <h1>بازی کلیکر – ماینینگ روزانه</h1>
          <div class="sub">ماینینگ ۲۴ ساعته • ذخیره دائمی (LocalStorage)</div>
        </div>
      </div>
      <button id="resetBtn" class="btn btn-gray">بازنشانی</button>
    </header>

    <main>
      <!-- Mining -->
      <section class="tab active" id="tab-mining">
        <div class="card row">
          <div>
            <div class="muted">موجودی</div>
            <div class="big"><span id="balance">0</span> <span class="muted" style="font-size:14px">سکه</span></div>
          </div>
          <div style="text-align:end">
            <div class="muted">وضعیت ماینینگ</div>
            <div id="miningStatus" class="pill">غیرفعال</div>
          </div>
        </div>

        <div class="card mine-wrap">
          <div class="row" style="align-items:flex-end">
            <div>
              <div class="muted">زمان باقی‌مانده</div>
              <div id="timer">00:00:00</div>
            </div>
            <div style="text-align:end">
              <div class="muted">درآمد این دوره</div>
              <div class="kicker"><span id="sessionEarnings" class="accent">0</span> سکه</div>
            </div>
          </div>
          <div class="progress"><div id="progressBar" style="width:0%"></div></div>
          <div class="row">
            <button id="startBtn" class="btn btn-brand mine-cta">شروع ماینینگ ۲۴ ساعته</button>
            <button id="claimBtn" class="btn btn-good mine-cta" disabled>اتمام و دریافت</button>
          </div>
          <div class="muted">نرخ فعلی: <span id="rateText">0</span> سکه/ثانیه • اگر از بازی خارج شوید، هنگام بازگشت ادامه محاسبه می‌شود.</div>
        </div>
      </section>

      <!-- Wallet -->
      <section class="tab" id="tab-wallet">
        <div class="card row">
          <div>
            <div class="muted">موجودی کل</div>
            <div class="big" id="walletBalance">0</div>
          </div>
          <button class="btn btn-gray" disabled title="برای دنیای واقعی به بک‌اند نیاز است">برداشت</button>
        </div>
        <div class="card">
          <div class="kicker" style="margin-bottom:8px">تراکنش‌ها</div>
          <ul id="txList" class="list"></ul>
          <div id="noTx" class="muted">هنوز تراکنشی وجود ندارد.</div>
        </div>
      </section>

      <!-- Friends / Referral -->
      <section class="tab" id="tab-friends">
        <div class="card">
          <div class="kicker" style="margin-bottom:8px">لینک دعوت شما</div>
          <div id="refLink" class="muted" style="word-break:break-all;background:#f1f5f9;border:1px dashed var(--border);padding:10px;border-radius:12px"></div>
          <div style="margin-top:8px;display:flex;gap:8px">
            <button id="copyRef" class="btn btn-brand">کپی لینک</button>
            <button id="mockInvite" class="btn btn-gray">شبیه‌سازی دعوت +۱</button>
          </div>
        </div>
        <div class="card row">
          <div>
            <div class="muted">تعداد دعوت‌ها</div>
            <div class="big" id="friendsCount">0</div>
          </div>
          <div class="pill good">به‌ازای هر دوست: ۳۰ سکه</div>
        </div>
      </section>

      <!-- Tasks -->
      <section class="tab" id="tab-tasks">
        <div class="card">
          <div class="kicker" style="margin-bottom:8px">وظایف روزانه/اجتماعی</div>
          <div id="tasksWrap" class="stack"></div>
          <div class="muted" style="margin-top:8px">* لینک‌ها نمونه هستند؛ برای اعتبارسنجی واقعی نیاز به بک‌اند دارید.</div>
        </div>
      </section>
    </main>

    <nav class="tabs">
      <div class="tabs-inner">
        <button class="tab-btn active" data-tab="mining"><span class="pill">ماینینگ</span></button>
        <button class="tab-btn" data-tab="wallet"><span class="pill">کیف پول</span></button>
        <button class="tab-btn" data-tab="friends"><span class="pill">دوستان</span></button>
        <button class="tab-btn" data-tab="tasks"><span class="pill">وظایف</span></button>
      </div>
    </nav>
  </div>

  <script>
    // ===== Config =====
    const DURATION_MS = 24 * 60 * 60 * 1000; // 24h mining period
    const RATE_PER_SEC = 0.02; // سکه در ثانیه (دلخواه)
    const REF_REWARD = 30; // جایزه هر دعوت

    const STORAGE_KEY = 'tg_clicker_plain_persist_v2';

    // ===== State =====
    const state = load() || {
      balance: 0,
      tx: [], // {id, type:'earn'|'spend', amount, ts, note}
      miningStartTime: null, // ms epoch
      friends: 0,
      completedTasks: []
    };

    // ===== Elements =====
    const $ = (id)=>document.getElementById(id);
    const balanceEl = $('balance');
    const miningStatusEl = $('miningStatus');
    const timerEl = $('timer');
    const sessionEarningsEl = $('sessionEarnings');
    const progressBarEl = $('progressBar');
    const startBtn = $('startBtn');
    const claimBtn = $('claimBtn');
    const rateText = $('rateText');

    const walletBalanceEl = $('walletBalance');
    const txListEl = $('txList');
    const noTxEl = $('noTx');

    const refLinkEl = $('refLink');
    const copyRefBtn = $('copyRef');
    const mockInviteBtn = $('mockInvite');
    const friendsCountEl = $('friendsCount');

    const tasksWrap = $('tasksWrap');

    // ===== Tasks (with sample links) =====
    const TASKS = [
      { id:'t1', title:'عضویت در کانال تلگرام', url:'https://t.me/telegram', reward:15 },
      { id:'t2', title:'فالو اینستاگرام', url:'https://instagram.com/instagram', reward:20 },
      { id:'t3', title:'فالو توییتر/X', url:'https://twitter.com/Twitter', reward:20 },
      { id:'t4', title:'سابسکرایب یوتیوب', url:'https://youtube.com/@YouTube', reward:25 },
      { id:'t5', title:'عضویت در گروه نمونه', url:'https://t.me/samples', reward:10 },
    ];

    // ===== Init =====
    rateText.textContent = RATE_PER_SEC.toLocaleString('fa-IR');
    setupTabs();
    setupMining();
    setupFriends();
    renderWallet();
    renderTasks();
    setupReset();

    // ===== Tabs =====
    function setupTabs(){
      document.querySelectorAll('.tab-btn').forEach(btn=>{
        btn.addEventListener('click',()=>{
          document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
          document.querySelectorAll('section.tab').forEach(s=>s.classList.remove('active'));
          btn.classList.add('active');
          document.getElementById('tab-'+btn.dataset.tab).classList.add('active');
        });
      });
    }

    // ===== Mining (persistent) =====
    let intervalId = null;

    function setupMining(){
      updateMiningUI();
      startBtn.addEventListener('click',()=>{
        if(state.miningStartTime) return; // already active
        state.miningStartTime = Date.now();
        pushTx({type:'info', amount:0, note:'شروع ماینینگ ۲۴ساعته'});
        save();
        updateMiningUI();
        tick();
        intervalId = setInterval(tick, 1000);
      });
      claimBtn.addEventListener('click', finalizeMining);

      // if a session is active, resume ticking
      if(state.miningStartTime){
        const {remaining} = miningMetrics();
        if(remaining>0){
          intervalId = setInterval(tick, 1000);
          tick();
        }else{
          // period already finished while user was away -> finalize immediately
          finalizeMining();
        }
      }
    }

    function miningMetrics(){
      if(!state.miningStartTime) return {elapsed:0, remaining:0, progress:0, rewardNow:0};
      const now = Date.now();
      const elapsed = Math.max(0, now - state.miningStartTime);
      const remaining = Math.max(0, DURATION_MS - elapsed);
      const clampedElapsed = Math.min(elapsed, DURATION_MS);
      const rewardNow = (clampedElapsed/1000) * RATE_PER_SEC;
      const progress = (clampedElapsed / DURATION_MS) * 100;
      return {elapsed, remaining, progress, rewardNow};
    }

    function formatHHMMSS(ms){
      const s = Math.max(0, Math.floor(ms/1000));
      const h = String(Math.floor(s/3600)).padStart(2,'0');
      const m = String(Math.floor((s%3600)/60)).padStart(2,'0');
      const ss = String(s%60).padStart(2,'0');
      return `${h}:${m}:${ss}`;
    }

    function tick(){
      const {remaining, progress, rewardNow} = miningMetrics();
      timerEl.textContent = formatHHMMSS(remaining);
      sessionEarningsEl.textContent = rewardNow.toFixed(2);
      progressBarEl.style.width = `${progress}%`;

      if(remaining<=0){
        clearInterval(intervalId); intervalId=null;
        claimBtn.disabled = false;
        miningStatusEl.textContent = 'پایان‌یافته – منتظر دریافت';
        miningStatusEl.className = 'pill warn';
      }
    }

    function finalizeMining(){
      if(!state.miningStartTime) return;
      const {rewardNow} = miningMetrics();
      if(rewardNow>0){
        state.balance += rewardNow;
        pushTx({type:'earn', amount:rewardNow, note:'پایان دوره ماینینگ'});
      }
      state.miningStartTime = null;
      save();
      updateMiningUI();
      renderWallet();
    }

    function updateMiningUI(){
      balanceEl.textContent = Math.floor(state.balance).toLocaleString('fa-IR');
      walletBalanceEl.textContent = Math.floor(state.balance).toLocaleString('fa-IR');

      if(state.miningStartTime){
        startBtn.disabled = true;
        claimBtn.disabled = true; // تا پایان دوره
        miningStatusEl.textContent = 'فعال';
        miningStatusEl.className = 'pill good';
        const {remaining, progress, rewardNow} = miningMetrics();
        timerEl.textContent = formatHHMMSS(remaining);
        sessionEarningsEl.textContent = rewardNow.toFixed(2);
        progressBarEl.style.width = `${progress}%`;
      }else{
        startBtn.disabled = false;
        claimBtn.disabled = true;
        miningStatusEl.textContent = 'غیرفعال';
        miningStatusEl.className = 'pill';
        timerEl.textContent = '00:00:00';
        sessionEarningsEl.textContent = '0';
        progressBarEl.style.width = '0%';
      }
    }

    // ===== Wallet / TX =====
    function renderWallet(){
      walletBalanceEl.textContent = Math.floor(state.balance).toLocaleString('fa-IR');
      txListEl.innerHTML = '';
      if(!state.tx.length){ noTxEl.style.display='block'; return; }
      noTxEl.style.display='none';
      state.tx.slice(0,50).forEach(t=>{
        const li=document.createElement('li');
        const left=document.createElement('div');
        const right=document.createElement('div');
        left.innerHTML = `<div>${t.type==='earn'?'+':''}${t.amount.toFixed(2)}</div><div class="muted">${t.note||'—'}</div>`;
        right.className='muted';
        right.textContent=new Date(t.ts).toLocaleString();
        li.appendChild(left); li.appendChild(right);
        txListEl.appendChild(li);
      });
    }

    function pushTx({type, amount, note}){
      state.tx.unshift({id:randId(), type, amount:amount||0, ts:Date.now(), note});
      state.tx = state.tx.slice(0,200);
      save();
    }

    // ===== Friends =====
    function setupFriends(){
      const url = new URL(window.location.href);
      const ref = url.searchParams.get('ref');
      // ساخت لینک دعوت شخصی (بدون ref یا با مقدار دلخواه)
      const base = `${location.origin}${location.pathname}`.replace(/index\.html$/,'');
      const myRef = 'USER_'+randId().slice(0,6); // نمونه؛ در نسخه واقعی از user.id تلگرام استفاده کنید
      const myLink = `${base}${base.endsWith('/')?'':'/'}index.html?ref=${encodeURIComponent(myRef)}`;
      refLinkEl.textContent = myLink;

      copyRefBtn.addEventListener('click', async ()=>{
        try{ await navigator.clipboard.writeText(myLink); }catch(e){}
      });
      mockInviteBtn.addEventListener('click',()=>{
        state.friends += 1;
        state.balance += REF_REWARD;
        pushTx({type:'earn', amount:REF_REWARD, note:'پاداش دعوت'});
        friendsCountEl.textContent = state.friends;
        updateMiningUI();
        renderWallet();
      });
      friendsCountEl.textContent = state.friends;

      // اگر کاربر با ref وارد شده، می‌توان این را در بک‌اند ثبت کرد.
      if(ref){
        // فقط نمایش اطلاع؛ امتیازدهی واقعی باید سروری باشد.
        pushTx({type:'info', amount:0, note:`ورود از طریق دعوت ${ref}`});
        renderWallet();
      }
    }

    // ===== Tasks =====
    function renderTasks(){
      tasksWrap.innerHTML='';
      TASKS.forEach(t=>{
        const done = state.completedTasks.includes(t.id);
        const card = document.createElement('div');
        card.className='card task';
        const meta = document.createElement('div');
        meta.className='meta';
        meta.innerHTML = `<a href="${t.url}" target="_blank" rel="noopener">${t.title}</a><span class="muted">پاداش: ${t.reward} سکه</span>`;
        const btn = document.createElement('button');
        btn.className='btn '+(done?'btn-gray':'btn-good');
        btn.textContent = done?'دریافت شد':'دریافت';
        btn.disabled = done;
        btn.addEventListener('click',()=>claimTask(t));
        card.appendChild(meta); card.appendChild(btn);
        tasksWrap.appendChild(card);
      });
    }

    function claimTask(t){
      if(state.completedTasks.includes(t.id)) return;
      state.completedTasks.push(t.id);
      state.balance += t.reward;
      pushTx({type:'earn', amount:t.reward, note:`پاداش وظیفه: ${t.title}`});
      save();
      renderTasks();
      updateMiningUI();
      renderWallet();
    }

    // ===== Reset =====
    function setupReset(){
      $('resetBtn').addEventListener('click',()=>{
        if(!confirm('همه پیشرفت‌ها (لوکال) حذف شود؟')) return;
        const keepRef = state.friends; // اگر خواستید صفر کنید، این خط را بردارید
        Object.assign(state,{balance:0, tx:[], miningStartTime:null, friends:keepRef, completedTasks:[]});
        save();
        updateMiningUI();
        renderWallet();
        renderTasks();
      });
    }

    // ===== Persistence =====
    function load(){ try{return JSON.parse(localStorage.getItem(STORAGE_KEY));}catch(e){return null;} }
    function save(){ try{localStorage.setItem(STORAGE_KEY, JSON.stringify(state));}catch(e){} }
    function randId(){ return (crypto.randomUUID?crypto.randomUUID():Math.random().toString(36).slice(2)); }
  </script>
</body>
</html>
