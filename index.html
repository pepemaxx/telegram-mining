<script>
const API = "https://pinet-backend-production.up.railway.app";

let balances = { coins: 0, pi: 0, usdt: 0 };
let miningStart = null;
const duration = 24*3600*1000;
const rate = 0.05;

function $(id){return document.getElementById(id)}

// Tabs
document.querySelectorAll(".tabs button").forEach(btn=>{
  btn.onclick=()=>{
    document.querySelectorAll(".tabs button").forEach(b=>b.classList.remove("active"));
    document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
    btn.classList.add("active");
    $("tab-"+btn.dataset.tab).classList.add("active");
  };
});

// Start mining
$("startBtn").onclick=()=>{
  miningStart=Date.now();
  localStorage.setItem("miningStart",miningStart);
  $("startBtn").disabled=true;
  $("claimBtn").disabled=true;
};

// Claim
$("claimBtn").onclick=()=>{
  let elapsed = duration; // یعنی کل ۲۴ ساعت تمام شده
  let earned = Math.floor(elapsed/1000*rate);
  balances.coins+=earned;
  localStorage.setItem("balances",JSON.stringify(balances));
  miningStart=null;
  localStorage.removeItem("miningStart");
  $("startBtn").disabled=false;
  $("claimBtn").disabled=true;
  $("sessionEarnings").textContent=0;
  $("timer").textContent="24:00:00";
  renderBalances();
};

// Tick timer
setInterval(()=>{
  if(miningStart){
    let elapsed = Date.now()-miningStart;
    let remain = duration-elapsed;
    if(remain<=0){
      $("timer").textContent="00:00:00";
      $("sessionEarnings").textContent=Math.floor(duration/1000*rate);
      $("claimBtn").disabled=false;
    }else{
      let h=Math.floor(remain/3600000);
      let m=Math.floor((remain%3600000)/60000);
      let s=Math.floor((remain%60000)/1000);
      $("timer").textContent=`${h.toString().padStart(2,"0")}:${m.toString().padStart(2,"0")}:${s.toString().padStart(2,"0")}`;
      $("sessionEarnings").textContent=Math.floor(elapsed/1000*rate);
    }
  }
},1000);

// Wallet functions
function renderBalances(){
  $("coinsBalance").textContent=balances.coins;
  $("piBalance").textContent=balances.pi;
  $("usdtBalance").textContent=balances.usdt;
}
$("coinsToPiBtn").onclick=()=>{
  let amt=+$("coinsToPiAmt").value;
  if(balances.coins>=amt){
    balances.coins-=amt; balances.pi+=amt/100;
    renderBalances(); localStorage.setItem("balances",JSON.stringify(balances));
  }
};
$("piToUsdtBtn").onclick=()=>{
  let amt=+$("piToUsdtAmt").value;
  if(balances.pi>=amt){
    balances.pi-=amt; balances.usdt+=amt*5;
    renderBalances(); localStorage.setItem("balances",JSON.stringify(balances));
  }
};
$("withdrawBtn").onclick=()=>{
  alert("Withdraw request sent to backend!");
};

// Manual mining
let cooldown=false;
$("manualMineBtn").onclick=()=>{
  if(cooldown)return;
  balances.coins+=0.5;
  renderBalances();
  cooldown=true;
  $("manualCooldown").textContent="Cooldown 10s";
  setTimeout(()=>{cooldown=false;$("manualCooldown").textContent="";},10000);
};

// Load state
window.onload=()=>{
  let saved=localStorage.getItem("balances");
  if(saved) balances=JSON.parse(saved);
  renderBalances();
  let ms=localStorage.getItem("miningStart");
  if(ms) miningStart=parseInt(ms);
};
</script>