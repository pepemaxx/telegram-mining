<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>PiProtocol â€“ Daily Mining</title>
<style>
/* ====== Theme ====== */
:root{
  --bg1:#4c1d95; --bg2:#7b2cbf; --ink:#fff; --muted:#cbd5e1;
  --brand:#f1c40f; --border:rgba(255,255,255,.18); --card:rgba(255,255,255,.08);
  --good:#10b981; --warn:#f59e0b; --danger:#ef4444;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; color:var(--ink); font-family:Inter, Vazirmatn, Segoe UI, Roboto, system-ui, -apple-system, sans-serif;
  background: radial-gradient(1200px 1200px at 70% -10%, rgba(255,255,255,.12), transparent 40%),
              linear-gradient(180deg,var(--bg1),var(--bg2));
  overflow:hidden;
}
body::after{
  content:""; position:fixed; inset:0; pointer-events:none; z-index:0;
  background:
    radial-gradient(400px 400px at 50% 30%, rgba(255,255,255,.12), transparent 60%),
    url('https://i.imgur.com/8L1Xk6D.png') center 24%/280px no-repeat;
  opacity:.06; filter: saturate(1.2);
}
#app{position:relative; z-index:1; height:100%; display:flex; flex-direction:column}
header{
position:sticky; top:0; z-index:5; background:rgba(0,0,0,.18); backdrop-filter:blur(10px);
border-bottom:1px solid var(--border); padding:12px 16px; display:flex; align-items:center; justify-content:space-between
}
.title{font-weight:900; font-size:18px; letter-spacing:.2px}
.sub{font-size:12px; color:var(--muted)}
main{flex:1; overflow-y:auto; padding:16px 16px 100px; max-width:980px; margin:0 auto; width:100%}

/* Cards */
.card{
background:var(--card); border:1px solid var(--border); border-radius:18px; padding:16px;
box-shadow: 0 8px 30px rgba(0,0,0,.20), inset 0 1px 0 rgba(255,255,255,.04);
backdrop-filter: blur(8px);
}
.row{display:flex; align-items:center; justify-content:space-between; gap:14px; flex-wrap:wrap}
.grid-2{display:grid; grid-template-columns:repeat(2, minmax(0,1fr)); gap:12px}
.grid-3{display:grid; grid-template-columns:repeat(3, minmax(0,1fr)); gap:12px}
@media (max-width:720px){ .grid-2,.grid-3{grid-template-columns:1fr} }

.big{font-size:28px; font-weight:900}
.kicker{font-size:12px; letter-spacing:.6px; color:var(--muted); font-weight:800; text-transform:uppercase}
.muted{color:var(--muted); font-size:12px}
.accent{color:var(--brand)}

/* Buttons & Inputs */
.btn{border:none; border-radius:14px; padding:10px 14px; font-weight:800; cursor:pointer; transition:transform .05s ease, filter .2s}
.btn:active{transform: translateY(1px)}
.btn-gold{background:linear-gradient(135deg,#fde047,#f59e0b); color:#3b0764}
.btn-ghost{background:rgba(255,255,255,.10); color:#fff; border:1px solid var(--border)}
.btn-danger{background:linear-gradient(135deg,#fca5a5,#ef4444); color:#3b0764}
.btn:disabled{opacity:.6; cursor:not-allowed}

input, select{
background:rgba(255,255,255,.10); color:#fff; border:1px solid var(--border); border-radius:12px;
padding:10px 12px; outline:none; width:100%
}
input::placeholder{color:#cbd5e1}
.input-row{display:flex; gap:8px; align-items:center; flex-wrap:wrap}

/* Status & progress */
.pill{font-size:12px; padding:4px 10px; border-radius:999px; border:1px solid var(--border); background:rgba(255,255,255,.06)}
.pill.good{background:rgba(16,185,129,.18); border-color:rgba(16,185,129,.4); color:#d1fae5}
.pill.warn{background:rgba(245,158,11,.16); border-color:rgba(245,158,11,.45)}
.pill.bad{background:rgba(239,68,68,.16); border-color:rgba(239,68,68,.45)}

.progress{height:10px; border-radius:999px; background:rgba(255,255,255,.18); overflow:hidden}
.progress>div{height:100%; background:linear-gradient(90deg,#fde047,#f59e0b); width:0%; transition: width .25s}

/* Tabs bar */
nav.tabs{position:fixed; left:0; right:0; bottom:0; border-top:1px solid var(--border); background:rgba(0,0,0,.22); backdrop-filter:blur(10px); z-index:5}
.tabs-inner{max-width:980px; margin:0 auto; height:72px; display:grid; grid-template-columns:repeat(5,1fr)}
.tab-btn{appearance:none; background:none; border:none; color:#e2e8f0; font-size:13px; display:flex; align-items:center; justify-content:center; gap:6px; flex-direction:column}
.tab-btn .mini{font-size:11px; opacity:.85}
.tab-btn.active{color:var(--brand)}
section.tab{display:none}
section.tab.active{display:block}

/* Tables */
.table{width:100%; border-collapse:collapse}
.table th, .table td{padding:10px; border-bottom:1px solid var(--border); text-align:right}
.table th{color:#f8fafc; font-weight:800; font-size:12px; opacity:.9}

/* Badges */
.badge{display:inline-flex; align-items:center; gap:6px; background:rgba(255,255,255,.08); border:1px solid var(--border); padding:6px 10px; border-radius:999px; font-size:12px}

/* Nice section headers */
.h3{font-size:16px; font-weight:900; margin:0 0 8px}
.h2{font-size:18px; font-weight:900; margin:0 0 10px}

/* Icon (inline) */
.icon{width:18px; height:18px; opacity:.9}

/* Share Modal */
.share-modal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0,0,0,0.7);
  z-index: 100;
  justify-content: center;
  align-items: center;
}

.share-modal-content {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: 18px;
  padding: 20px;
  width: 90%;
  max-width: 400px;
  backdrop-filter: blur(10px);
}

.share-apps {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 10px;
  margin-top: 15px;
}

.share-app {
  display: flex;
  flex-direction: column;
  align-items: center;
  padding: 10px;
  background: rgba(255,255,255,0.1);
  border-radius: 12px;
  cursor: pointer;
  transition: background 0.2s;
}

.share-app:hover {
  background: rgba(255,255,255,0.2);
}

.share-app svg {
  width: 30px;
  height: 30px;
  margin-bottom: 5px;
}

.share-app span {
  font-size: 12px;
}
</style>

</head>
<body>
<div id="app">
  <!-- Header -->
  <header>
    <div>
      <div class="title">PiProtocol â€“ Daily Mining</div>
      <div class="sub">24h mining â€¢ Local persistence + API fallback</div>
    </div>
  </header>

  <!-- Main -->
  <main>
    <!-- Mining -->
    <section class="tab active" id="tab-mining">
      <div class="card row">
        <div>
          <div class="kicker">Wallet Balance</div>
          <div class="big"><span id="balance">0</span> <span class="muted" style="font-size:14px">coins</span></div>
        </div>
        <div style="text-align:end">
          <div class="kicker">Mining Status</div>
          <div id="miningStatus" class="pill">Inactive</div>
        </div>
      </div>

      <div class="card">
        <div class="row" style="align-items:flex-end">
          <div>
            <div class="kicker">Time remaining</div>
            <div id="timer" class="big">00:00:00</div>
          </div>
          <div style="text-align:end">
            <div class="kicker">Session earnings</div>
            <div class="big accent"><span id="sessionEarnings">0</span> coins</div>
          </div>
        </div>
        <div class="progress" style="margin-top:10px"><div id="progressBar"></div></div>
        <div class="row" style="margin-top:12px">
          <button id="startBtn" class="btn btn-gold">Start 20s</button>
          <button id="claimBtn" class="btn btn-ghost" disabled>Finish & Claim</button>
        </div>
        <div class="muted" style="margin-top:8px">Rate: <b id="rateText">0.05</b> coin/sec â€¢ Ù‡Ø± Ø¨Ø§Ø± <b>Start</b> Ø±Ø§ Ø¨Ø²Ù†ÛŒØ¯ ØªØ§ÛŒÙ…Ø± Ø§Ø² Ø§ÙˆÙ„ Ø´Ø±ÙˆØ¹ Ù…ÛŒâ€ŒØ´ÙˆØ¯.</div>
      </div>

      <!-- News -->
      <div class="card">
        <div class="row" style="justify-content:space-between">
          <div class="h2">Ø§Ø®Ø¨Ø§Ø±</div>
          <div class="badge"><svg class="icon" viewBox="0 0 24 24" fill="currentColor"><path d="M4 4h13a3 3 0 0 1 3 3v10a3 3 0 0 1-3 3H7a3 3 0 0 1-3-3V4z"/><path d="M8 8h8M8 12h8M8 16h6" stroke="#000" stroke-opacity=".28"/></svg> Latest</div>
        </div>
        <ul id="newsList" style="margin:6px 0 0 0; padding:0; list-style:none"></ul>
      </div>
    </section>

    <!-- Wallet -->
    <section class="tab" id="tab-wallet">
      <div class="grid-3">
        <div class="card">
          <div class="kicker">Coins</div>
          <div class="big"><span id="coinsBalance">0</span></div>
        </div>
        <div class="card">
          <div class="kicker">PiNet</div>
          <div class="big"><span id="piBalance">0.00</span></div>
        </div>
        <div class="card">
          <div class="kicker">USDT</div>
          <div class="big"><span id="usdtBalance">0.00</span></div>
        </div>
      </div>

      <div class="grid-2" style="margin-top:12px">
        <!-- Convert Coins -> Pi -->
        <div class="card">
          <div class="h3">ğŸ”„ ØªØ¨Ø¯ÛŒÙ„ Coins â†’ PiNet</div>
          <div class="muted" style="margin-bottom:6px">Ù†Ø±Ø® Ù†Ù…Ø§ÛŒØ´ÛŒ: <b id="coinsPerPi">100</b>coins = 1 PiNet</div>
          <div class="input-row">
            <input id="coinsToPiAmt" type="number" min="0" step="1" placeholder="Ù…Ù‚Ø¯Ø§Ø± Ú©ÙˆÛŒÙ†">
            <button id="coinsToPiBtn" class="btn btn-gold">ØªØ¨Ø¯ÛŒÙ„</button>
          </div>
          <div id="coinsToPiHint" class="muted" style="margin-top:6px"></div>
        </div>

        <!-- Convert Pi -> USDT -->
        <div class="card">
          <div class="h3">ğŸ’± ØªØ¨Ø¯ÛŒÙ„ PiNet â†’ USDT</div>
          <div class="muted" style="margin-bottom:6px">Ù†Ø±Ø® Ù†Ù…Ø§ÛŒØ´ÛŒ: 1 Pi = <b id="usdtPerPi">5</b> USDT</div>
          <div class="input-row">
            <input id="piToUsdtAmt" type="number" min="0" step="0.01" placeholder="Ù…Ù‚Ø¯Ø§Ø± Pi">
            <button id="piToUsdtBtn" class="btn btn-gold">ØªØ¨Ø¯ÛŒÙ„</button>
          </div>
          <div id="piToUsdtHint" class="muted" style="margin-top:6px"></div>
        </div>
      </div>

      <!-- Withdraw -->
      <div class="card" style="margin-top:12px">
        <div class="h3">ğŸ¦ Ø¨Ø±Ø¯Ø§Ø´Øª</div>
        <div class="grid-3">
          <div>
            <div class="muted">Ù†ÙˆØ¹ Ø¯Ø§Ø±Ø§ÛŒÛŒ</div>
            <select id="withdrawAsset">
              <option value="pi">PiNet</option>
              <option value="usdt">USDT</option>
            </select>
          </div>
          <div>
            <div class="muted">Ø¢Ø¯Ø±Ø³ Ú©ÛŒÙ Ù¾ÙˆÙ„</div>
            <input id="withdrawAddr" placeholder="Ù…Ø«Ù„Ø§Ù‹ Pi wallet / TRON / ERC-20"/>
          </div>
          <div>
            <div class="muted">Ù…Ù‚Ø¯Ø§Ø±</div>
            <input id="withdrawAmt" type="number" min="0" step="0.01" placeholder="Amount"/>
          </div>
        </div>
        <div class="row" style="margin-top:10px">
          <button id="withdrawBtn" class="btn btn-gold">Ø«Ø¨Øª Ø¯Ø±Ø®ÙˆØ§Ø³Øª</button>
          <div class="muted">Ø¨Ø±Ø§ÛŒ Ù¾Ø±Ø¯Ø§Ø²Ø´ ÙˆØ§Ù‚Ø¹ÛŒØŒ Ù†ÛŒØ§Ø² Ø¨Ù‡ ØªØ£ÛŒÛŒØ¯ Ø³Ù…Øª Ø³Ø±ÙˆØ± Ø¯Ø§Ø±ÛŒØ¯.</div>
        </div>
      </div>

      <!-- Transactions -->
      <div class="card" style="margin-top:12px">
        <div class="h3">ØªØ±Ø§Ú©Ù†Ø´â€ŒÙ‡Ø§</div>
        <table class="table">
          <thead><tr><th>ØªÙˆØ¶ÛŒØ­</th><th>Ù…Ù‚Ø¯Ø§Ø±</th><th>Ø²Ù…Ø§Ù†</th></tr></thead>
          <tbody id="txList"></tbody>
        </table>
        <div id="noTx" class="muted" style="margin-top:6px">Ù‡Ù†ÙˆØ² ØªØ±Ø§Ú©Ù†Ø´ÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯.</div>
      </div>
    </section>

    <!-- Friends -->
    <section class="tab" id="tab-friends">
      <div class="card">
        <div class="h3">Ù„ÛŒÙ†Ú© Ø¯Ø¹ÙˆØª Ø´Ù…Ø§</div>
        <div id="refLink" class="muted" style="word-break:break-all;background:rgba(255,255,255,.08);border:1px dashed var(--border);padding:10px;border-radius:12px"></div>
        <div class="row" style="margin-top:8px">
          <button id="copyRef" class="btn btn-gold">Ú©Ù¾ÛŒ Ù„ÛŒÙ†Ú©</button>
          <button id="shareRef" class="btn btn-ghost">Ø§Ø´ØªØ±Ø§Ú© Ú¯Ø°Ø§Ø±ÛŒ</button>
        </div>
      </div>

      <div class="grid-3" style="margin-top:12px">
        <div class="card">
          <div class="kicker">Invited</div>
          <div class="big" id="friendsInvited">0</div>
        </div>
        <div class="card">
          <div class="kicker">Active</div>
          <div class="big" id="friendsActive">0</div>
        </div>
        <div class="card">
          <div class="kicker">Ù¾Ø§Ø¯Ø§Ø´</div>
          <div class="big accent">+30 coins / active</div>
        </div>
      </div>

      <div class="card" style="margin-top:12px">
        <div class="h3">Ø±Ù†Ø¯Û€ Ø¨Ø±ØªØ± (Top 10)</div>
        <table class="table" id="leaderTable">
          <thead><tr><th>#</th><th>Ú©Ø§Ø±Ø¨Ø±</th><th>Coins</th></tr></thead>
          <tbody></tbody>
        </table>
        <div class="muted" style="margin-top:6px">Ø±ØªØ¨Ù‡ Ø´Ù…Ø§: <b id="myRank">#â€”</b></div>
      </div>
    </section>

    <!-- Tasks -->
    <section class="tab" id="tab-tasks">
      <div class="card">
        <div class="h3">ØªØ³Ú©â€ŒÙ‡Ø§ÛŒ Ø±ÙˆØ²Ø§Ù†Ù‡ Ùˆ Ø§Ø¬ØªÙ…Ø§Ø¹ÛŒ</div>
        <div id="tasksWrap"></div>
        <div class="muted" style="margin-top:6px">* Ø¨Ø±Ø§ÛŒ ØªØ£ÛŒÛŒØ¯ ÙˆØ§Ù‚Ø¹ÛŒ Ù„ÛŒÙ†Ú©â€ŒÙ‡Ø§ Ø¨Ù‡ Ø¨Ú©â€ŒØ§Ù†Ø¯ Ù†ÛŒØ§Ø² Ø¯Ø§Ø±ÛŒØ¯.</div>
      </div>

      <div class="card" style="margin-top:12px">
        <div class="h3">âš’ï¸ Manual Mining</div>
        <div class="row">
          <div class="muted">Ø¨Ø§ Ù‡Ø± Ú©Ù„ÛŒÚ© +0.5 coin (Cooldown 10s)</div>
          <button id="manualMineBtn" class="btn btn-gold">Mine +0.5</button>
        </div>
        <div id="manualCooldown" class="muted" style="margin-top:6px"></div>
      </div>
    </section>

    <!-- Profile -->
    <section class="tab" id="tab-profile">
      <div class="card">
        <div class="h3">Ù¾Ø±ÙˆÙØ§ÛŒÙ„</div>
        <div class="input-row" style="margin-top:6px">
          <input id="firstName" placeholder="Ù†Ø§Ù…">
          <input id="lastName" placeholder="Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ">
          <input id="userId" placeholder="Ø´Ù†Ø§Ø³Ù‡ Ú©Ø§Ø±Ø¨Ø±">
          <button id="saveProfile" class="btn btn-gold">Ø°Ø®ÛŒØ±Ù‡</button>
        </div>
        <div class="muted" style="margin-top:6px">Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø±ÙˆÛŒ Ù‡Ù…ÛŒÙ† Ø¯Ø³ØªÚ¯Ø§Ù‡ Ø°Ø®ÛŒØ±Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯.</div>
      </div>
    </section>

  </main>

  <!-- Tabs bar -->
  <nav class="tabs">
    <div class="tabs-inner">
      <button class="tab-btn active" data-tab="mining">Mining <span class="mini">24h</span></button>
      <button class="tab-btn" data-tab="wallet">Wallet <span class="mini">Convert</span></button>
      <button class="tab-btn" data-tab="friends">Friends <span class="mini">Rank</span></button>
      <button class="tab-btn" data-tab="tasks">Tasks <span class="mini">Daily</span></button>
      <button class="tab-btn" data-tab="profile">Profile <span class="mini">You</span></button>
    </div>
  </nav>
</div>

<!-- Share Modal -->
<div id="shareModal" class="share-modal">
  <div class="share-modal-content">
    <div class="h3">Ø§Ø´ØªØ±Ø§Ú© Ú¯Ø°Ø§Ø±ÛŒ Ù„ÛŒÙ†Ú© Ø¯Ø¹ÙˆØª</div>
    <div class="muted">Ù„ÛŒÙ†Ú© Ø¯Ø¹ÙˆØª Ø®ÙˆØ¯ Ø±Ø§ Ø§Ø² Ø·Ø±ÛŒÙ‚ Ø¨Ø±Ù†Ø§Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Ø²ÛŒØ± Ø¨Ù‡ Ø§Ø´ØªØ±Ø§Ú© Ø¨Ú¯Ø°Ø§Ø±ÛŒØ¯</div>
    <div class="share-apps">
      <div class="share-app" data-app="whatsapp">
        <svg viewBox="0 0 24 24" fill="#25D366">
          <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893A11.821 11.821 0 0020.864 3.488"/>
        </svg>
        <span>WhatsApp</span>
      </div>
      <div class="share-app" data-app="telegram">
        <svg viewBox="0 0 24 24" fill="#0088cc">
          <path d="M12 0C5.373 0 0 5.373 0 12s5.373 12 12 12 12-5.373 12-12S18.627 0 12 0zm5.894 8.221l-1.97 9.28c-.145.658-.537.818-1.084.508l-3-2.21-1.447 1.394c-.16.16-.295.295-.605.295l.213-3.053 5.56-5.022c.242-.213-.054-.334-.373-.121l-6.869 4.326-2.96-.924c-.64-.203-.658-.64.136-.954l11.566-4.458c.538-.196 1.006.128.832.941z"/>
        </svg>
        <span>Telegram</span>
      </div>
      <div class="share-app" data-app="limoo">
        <svg viewBox="0 0 24 24" fill="#ff5722">
          <circle cx="12" cy="12" r="12"/>
          <text x="12" y="16" text-anchor="middle" fill="white" font-size="10">Limo</text>
        </svg>
        <span>Limo</span>
      </div>
      <div class="share-app" data-app="copy">
        <svg viewBox="0 0 24 24" fill="#9e9e9e">
          <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
        </svg>
        <span>Ú©Ù¾ÛŒ</span>
      </div>
      <div class="share-app" data-app="more">
        <svg viewBox="0 0 24 24" fill="#9e9e9e">
          <path d="M12 8c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"/>
        </svg>
        <span>Ø³Ø§ÛŒØ±</span>
      </div>
    </div>
    <div class="row" style="margin-top:15px; justify-content:flex-end">
      <button id="closeShareModal" class="btn btn-ghost">Ø¨Ø³ØªÙ†</button>
    </div>
  </div>
</div>

<script>
/* ================== Config ================== */
const API_BASE = 'https://pinet-backend-production.up.railway.app'; // Backend base (provided)
const STORAGE_KEY = 'pinet_clicker_state_v5';
const DURATION_MS = 30*1000;  // 30s
const RATE_PER_SEC = 0.05;          // coins/sec demo
const COINS_PER_PI = 100;           // 100 coins => 1 Pi
const USDT_PER_PI  = 5;             // 1 Pi => 5 USDT
const REF_REWARD   = 30;            // coins per active friend
const MANUAL_GAIN  = 0.5;
const MANUAL_COOLDOWN = 10*1000;

/* ================== State ================== */
const state = load() || {
  coins: 0, pi: 0, usdt: 0,
  tx: [],                 // {id,type,amount,ts,note}
  miningStart: null,
  friendsInvited: 0, friendsActive: 0,
  profile: { first:'', last:'', id:'' },
  myRank: 112131,
  completedTasks: [],
  lastManual: 0,
  taskStatuses: {},
  lastResetDate: new Date().toDateString() // Ø§ÙØ²ÙˆØ¯Ù† Ø§ÛŒÙ† Ø®Ø·
};

/* ================== Elements ================== */
// Mining
const $ = (id)=>document.getElementById(id);
const balanceEl = $('balance');
const miningStatusEl = $('miningStatus');
const timerEl = $('timer');
const sessionEarningsEl = $('sessionEarnings');
const progressBarEl = $('progressBar');
const rateText = $('rateText');
const startBtn = $('startBtn');
const claimBtn = $('claimBtn');

// Wallet
const coinsBalanceEl = $('coinsBalance');
const piBalanceEl = $('piBalance');
const usdtBalanceEl = $('usdtBalance');
const coinsToPiAmt = $('coinsToPiAmt');
const coinsToPiBtn = $('coinsToPiBtn');
const coinsToPiHint = $('coinsToPiHint');
const piToUsdtAmt = $('piToUsdtAmt');
const piToUsdtBtn = $('piToUsdtBtn');
const piToUsdtHint = $('piToUsdtHint');
const withdrawAsset = $('withdrawAsset');
const withdrawAddr = $('withdrawAddr');
const withdrawAmt = $('withdrawAmt');
const withdrawBtn = $('withdrawBtn');
const txListEl = $('txList');
const noTxEl = $('noTx');

// Friends
const refLinkEl = $('refLink');
const copyRefBtn = $('copyRef');
const shareRefBtn = $('shareRef');
const friendsInvitedEl = $('friendsInvited');
const friendsActiveEl = $('friendsActive');
const leaderTable = $('leaderTable').querySelector('tbody');
const myRankEl = $('myRank');

// Tasks
const tasksWrap = $('tasksWrap');
const manualMineBtn = $('manualMineBtn');
const manualCooldownEl = $('manualCooldown');

// Profile
const firstNameInput = $('firstName');
const lastNameInput  = $('lastName');
const userIdInput    = $('userId');
const saveProfileBtn = $('saveProfile');

// Header

// News
const newsListEl = $('newsList');

// Share Modal
const shareModal = $('shareModal');
const closeShareModal = $('closeShareModal');
const shareApps = document.querySelectorAll('.share-app');

// Misc
$('coinsPerPi').textContent = COINS_PER_PI;
$('usdtPerPi').textContent  = USDT_PER_PI;
rateText && (rateText.textContent = RATE_PER_SEC.toString());

/* ================== Tabs ================== */
document.querySelectorAll('.tab-btn').forEach(btn=>{
  btn.addEventListener('click',()=>{
    document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
    document.querySelectorAll('section.tab').forEach(s=>s.classList.remove('active'));
    btn.classList.add('active');
    document.getElementById('tab-'+btn.dataset.tab).classList.add('active');
  });
});

/* ================== Mining Logic ================== */
let tickId=null;

function formatHHMMSS(ms){
  const s = Math.max(0, Math.floor(ms/1000));
  const h = String(Math.floor(s/3600)).padStart(2,'0');
  const m = String(Math.floor((s%3600)/60)).padStart(2,'0');
  const ss= String(s%60).padStart(2,'0');
  return `${h}:${m}:${ss}`;
}
function miningMetrics(){
  if(!state.miningStart) return {elapsed:0, remaining:0, progress:0, rewardNow:0};
  const now = Date.now();
  const elapsed = Math.max(0, now - state.miningStart);
  const remaining = Math.max(0, DURATION_MS - elapsed);
  const clamped = Math.min(elapsed, DURATION_MS);
  const rewardNow = (clamped/1000) * RATE_PER_SEC;
  const progress = (clamped / DURATION_MS) * 100;
  return {elapsed, remaining, progress, rewardNow};
}
function runTick(){
  clearInterval(tickId);
  tick();
  tickId = setInterval(tick, 1000);
}

function tick(){
  // Ø§Ú¯Ø± Ù…Ø§ÛŒÙ†ÛŒÙ†Ú¯ ÙØ¹Ø§Ù„ Ù†ÛŒØ³ØªØŒ Ø­Ø§Ù„Øª Ù¾ÛŒØ´â€ŒÙØ±Ø¶ Ø±Ø§ Ù†Ø´Ø§Ù† Ø¨Ø¯Ù‡
  if(!state.miningStart){
    miningStatusEl.textContent='Inactive';
    miningStatusEl.className='pill';
    claimBtn.disabled=true;
    timerEl.textContent='00:00:00';
    sessionEarningsEl.textContent='0';
    progressBarEl.style.width='0%';
    return;
  }

  const {remaining, progress, rewardNow} = miningMetrics();
  timerEl.textContent = formatHHMMSS(remaining);
  sessionEarningsEl.textContent = rewardNow.toFixed(2);
  progressBarEl.style.width = `${progress}%`;

  // ÙˆÙ‚ØªÛŒ ØªØ§ÛŒÙ…Ø± ØªÙ…Ø§Ù… Ø´Ø¯: Ø¯Ú©Ù…Ù‡ Claim ÙØ¹Ø§Ù„ Ø´ÙˆØ¯ Ùˆ ÙˆØ¶Ø¹ÛŒØª Ø¨Ù‡ Completed ØªØºÛŒÛŒØ± Ú©Ù†Ø¯
  if(remaining<=0){
    clearInterval(tickId); tickId=null;
    claimBtn.disabled=false;
    miningStatusEl.textContent='Completed â€“ claim pending';
    miningStatusEl.className='pill warn';
  }else{
    claimBtn.disabled=true;
    miningStatusEl.textContent='Active';
    miningStatusEl.className='pill good';
  }
}

startBtn.addEventListener('click', async ()=>{
  // Ù‡Ø± Ø¨Ø§Ø± Start: Ø§Ø² Ø§ÙˆÙ„ Ø´Ø±ÙˆØ¹ Ù…ÛŒâ€ŒØ´ÙˆØ¯
  state.miningStart = Date.now();
  pushTx({type:'info', amount:0, note:'Started 24h mining', ts: Date.now()});
  save(); updateMiningUI(); runTick();

  // Optional: ping backend (ignore failure)
  try{
    await fetch(`${API_BASE}/mining/start`,{method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ts:state.miningStart})});
  }catch(e){}
});
claimBtn.addEventListener('click', async ()=>{
  // Ø§Ú¯Ø± Ù…Ø§ÛŒÙ†ÛŒÙ†Ú¯ Ø´Ø±ÙˆØ¹ Ù†Ø´Ø¯Ù‡ØŒ ÛŒØ§ Ù‡Ù†ÙˆØ² ØªØ§ÛŒÙ…Ø± ØªÙ…Ø§Ù… Ù†Ø´Ø¯Ù‡ØŒ Ø§Ø¬Ø§Ø²Ù‡ Ù†Ø¯Ù‡
  if(!state.miningStart) return;
  const {remaining, rewardNow} = miningMetrics();

  // Ø§Ú¯Ø± Ù‡Ù†ÙˆØ² Ú©Ø§Ù…Ù„ Ù†Ø´Ø¯Ù‡ØŒ Ø§Ø¬Ø§Ø²Ù‡ Ù†Ø¯Ù‡ (Ø§Ø¶Ø·Ø±Ø§Ø±ÛŒ)
  if(remaining>0) return alert('ØªØ§ÛŒÙ…Ø± Ù‡Ù†ÙˆØ² ØªÙ…Ø§Ù… Ù†Ø´Ø¯Ù‡.');

  const reward = Number(rewardNow.toFixed(2));
  if(reward>0){
    state.coins += reward;
    pushTx({type:'earn', amount:reward, note:'Mining session reward', ts: Date.now()});
  }

  // Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ø¬Ù„Ø³Ù‡ Ù…Ø§ÛŒÙ†ÛŒÙ†Ú¯ (Ù…Ù†ØªØ¸Ø± Ú©Ø§Ø±Ø¨Ø± Ø¨Ø±Ø§ÛŒ Ø´Ø±ÙˆØ¹ Ù…Ø¬Ø¯Ø¯)
  state.miningStart = null;
  save();
  updateMiningUI();
  renderWallet();

  // Ø§Ø±Ø³Ø§Ù„ Ø¨Ù‡ Ø³Ø±ÙˆØ± (Ø§Ø®ØªÛŒØ§Ø±ÛŒØŒ Ø®Ø·Ø§Ù‡Ø§ Ø±Ø§ Ù†Ø§Ø¯ÛŒØ¯Ù‡ Ø¨Ú¯ÛŒØ±)
  try{
    await fetch(`${API_BASE}/claim`,{method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({amount:reward, ts: Date.now()})});
  }catch(e){}
});

function updateMiningUI(){
  // Ø¨Ù‡ Ø³Ø§Ø¯Ú¯ÛŒ render Ù…Ø±Ø¨ÙˆØ·Ù‡ Ø±Ø§ Ø¨Ø§ Ù‡Ù…Ø§Ù† Ù…Ù†Ø·Ù‚ tick Ø§Ù†Ø¬Ø§Ù… Ø¨Ø¯Ù‡ (ØªØ§ Ù‡Ù…ÛŒØ´Ù‡ Ù‡Ù…Ú¯Ø§Ù… Ø¨Ø§Ø´Ø¯)
  if(state.miningStart){
    // Ø§Ú¯Ø± Ø¯Ø± Ø­Ø§Ù„ Ù…Ø§ÛŒÙ†ÛŒÙ†Ú¯ Ø§Ø³ØªØŒ ÙˆØ¶Ø¹ÛŒØª Ø±Ø§ Ø¨Ø± Ø§Ø³Ø§Ø³ Ù…ØªØ±ÛŒÚ©â€ŒÙ‡Ø§ Ù†Ù…Ø§ÛŒØ´ Ø¨Ø¯Ù‡
    const {remaining, progress, rewardNow} = miningMetrics();
    timerEl.textContent = formatHHMMSS(remaining);
    sessionEarningsEl.textContent = rewardNow.toFixed(2);
    progressBarEl.style.width = `${progress}%`;

    if(remaining <= 0){
      claimBtn.disabled = false;
      miningStatusEl.textContent = 'Completed â€“ claim pending';
      miningStatusEl.className = 'pill warn';
    }else{
      claimBtn.disabled = true;
      miningStatusEl.textContent = 'Active';
      miningStatusEl.className = 'pill good';
    }
  }else{
    // ÙˆÙ‚ØªÛŒ miningStart null Ø§Ø³ØªØŒ Ø¯Ú©Ù…Ù‡ Claim ØºÛŒØ±ÙØ¹Ø§Ù„ Ø¨Ø§Ø´Ø¯
    claimBtn.disabled = true;
    miningStatusEl.textContent = 'Inactive';
    miningStatusEl.className = 'pill';
    timerEl.textContent='00:00:00';
    sessionEarningsEl.textContent='0';
    progressBarEl.style.width='0%';
  }

  balanceEl.textContent = Math.floor(state.coins).toLocaleString('en-US');
}

/* ================== Wallet & Conversions ================== */
function renderWallet(){
  coinsBalanceEl.textContent = Math.floor(state.coins).toLocaleString('en-US');
  piBalanceEl.textContent = Number(state.pi).toFixed(2);
  usdtBalanceEl.textContent = Number(state.usdt).toFixed(2);

  // transactions
  txListEl.innerHTML='';
  if(!state.tx.length){ noTxEl.style.display='block'; return; }
  noTxEl.style.display='none';
  state.tx.slice(0,80).forEach(t=>{
    const tr = document.createElement('tr');
    const td1 = document.createElement('td'); td1.innerHTML = `<div>${t.note||'â€”'}</div><div class="muted">${t.type}</div>`;
    const td2 = document.createElement('td'); td2.textContent = (t.type==='earn'?'+':'') + Number(t.amount).toFixed(2);
    const td3 = document.createElement('td'); td3.className='muted'; td3.textContent = new Date(t.ts||Date.now()).toLocaleString();
    tr.appendChild(td1); tr.appendChild(td2); tr.appendChild(td3);
    txListEl.appendChild(tr);
  });
}

coinsToPiBtn.addEventListener('click', async ()=>{
  const coins = Math.max(0, Math.floor(Number(coinsToPiAmt.value||0)));
  if(!coins) return alert('Ù…Ù‚Ø¯Ø§Ø± Ù…Ø¹ØªØ¨Ø± ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯');
  if(coins > state.coins) return alert('Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ú©ÙˆÛŒÙ† Ú©Ø§ÙÛŒ Ù†ÛŒØ³Øª');
  const pi = coins / COINS_PER_PI;
  state.coins -= coins; state.pi += pi;
  pushTx({type:'swap', amount:pi, note:`Convert ${coins} coins â†’ ${pi.toFixed(2)} Pi`, ts: Date.now()});
  save(); renderWallet(); updateMiningUI();
  coinsToPiAmt.value='';
  coinsToPiHint.textContent = `â‰ˆ ${pi.toFixed(2)} Pi`;
  try{
    await fetch(`${API_BASE}/convert/coins-to-pi`,{method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({coins, pi})});
  }catch(e){}
});

piToUsdtBtn.addEventListener('click', async ()=>{
  const pi = Math.max(0, Number(piToUsdtAmt.value||0));
  if(!pi) return alert('Ù…Ù‚Ø¯Ø§Ø± Ù…Ø¹ØªØ¨Ø± ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯');
  if(pi > state.pi) return alert('Ù…ÙˆØ¬ÙˆØ¯ÛŒ Pi Ú©Ø§ÙÛŒ Ù†ÛŒØ³Øª');
  const usdt = pi * USDT_PER_PI;
  state.pi -= pi; state.usdt += usdt;
  pushTx({type:'swap', amount:usdt, note:`Convert ${pi} Pi â†’ ${usdt.toFixed(2)} USDT`, ts: Date.now()});
  save(); renderWallet();
  piToUsdtAmt.value='';
  piToUsdtHint.textContent = `â‰ˆ ${usdt.toFixed(2)} USDT`;
  try{
    await fetch(`${API_BASE}/convert/pi-to-usdt`,{method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({pi, usdt})});
  }catch(e){}
});

withdrawBtn.addEventListener('click', async ()=>{
  const asset = withdrawAsset.value;
  const addr = withdrawAddr.value.trim();
  const amt = Math.max(0, Number(withdrawAmt.value||0));
  if(!addr || !amt) return alert('Ù‡Ù…Ù‡ ÙÛŒÙ„Ø¯Ù‡Ø§ Ø±Ø§ Ú©Ø§Ù…Ù„ Ú©Ù†ÛŒØ¯');
  if(asset==='pi' && amt>state.pi) return alert('Ù…ÙˆØ¬ÙˆØ¯ÛŒ Pi Ú©Ø§ÙÛŒ Ù†ÛŒØ³Øª');
  if(asset==='usdt' && amt>state.usdt) return alert('Ù…ÙˆØ¬ÙˆØ¯ÛŒ USDT Ú©Ø§ÙÛŒ Ù†ÛŒØ³Øª');

  // Ù…Ø­Ù„ÛŒ: ÙÙ‚Ø· Ø«Ø¨Øª ØªØ±Ø§Ú©Ù†Ø´ Ù†Ù…Ø§ÛŒØ´ÛŒ
  pushTx({type:'withdraw', amount:amt, note:`Withdraw request ${amt} ${asset.toUpperCase()} â†’ ${addr.slice(0,12)}...`, ts: Date.now()});
  save(); renderWallet();

  try{
    const res = await fetch(`${API_BASE}/withdraw`,{
      method:'POST', headers:{'Content-Type':'application/json'},
      body:JSON.stringify({asset, address:addr, amount:amt})
    });
    // Ø§Ú¯Ø± Ù†ÛŒØ§Ø²: Ù¾Ø§Ø³Ø® Ø±Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†ÛŒØ¯
  }catch(e){}
  alert('Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø¨Ø±Ø¯Ø§Ø´Øª Ø«Ø¨Øª Ø´Ø¯ (Ø¯Ù…Ùˆ). Ø¨Ø±Ø§ÛŒ Ø¨Ø±Ø¯Ø§Ø´Øª ÙˆØ§Ù‚Ø¹ÛŒØŒ ØªØ£ÛŒÛŒØ¯ Ø¨Ú©â€ŒØ§Ù†Ø¯ Ø§Ù„Ø²Ø§Ù…ÛŒ Ø§Ø³Øª.');
});

/* ================== Friends & Rank ================== */
const FAKE_TOP10 = ['ShadowFox','NovaStar','PixelWave','IronClad','BlueComet','SilentPeak','QuantumBee','BrightMint','ArcticFlame','NeonDash'];
function setupFriends(){
  // referral link + backend registration
  const base = "https://t.me/piprotocolbot"; 
  const userCode = state.profile.id || rid().slice(0,6); 
  const myLink = `${base}?start=${encodeURIComponent(userCode)}`;
  refLinkEl.textContent = myLink;

  // Ø¨Ø±Ø±Ø³ÛŒ Ø§Ú¯Ø± Ø§Ø² Ø·Ø±ÛŒÙ‚ Ù„ÛŒÙ†Ú© Ø¯Ø¹ÙˆØª ÙˆØ§Ø±Ø¯ Ø´Ø¯Ù‡ Ø¨Ø§Ø´Ø¯
  const urlParams = new URLSearchParams(window.location.search);
  const inviterCode = urlParams.get('start');
  if(inviterCode && inviterCode !== userCode){
    fetch(`${API_BASE}/referral/register`, {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ inviterCode, userId: userCode })
    }).catch(e=>console.error('Referral registration failed', e));
  }

  copyRefBtn.addEventListener('click', async ()=>{ 
    try{ 
      await navigator.clipboard.writeText(myLink); 
      alert('Ù„ÛŒÙ†Ú© Ø¯Ø¹ÙˆØª Ú©Ù¾ÛŒ Ø´Ø¯!');
    }catch(e){
      // Fallback for older browsers
      const textArea = document.createElement('textarea');
      textArea.value = myLink;
      document.body.appendChild(textArea);
      textArea.select();
      document.execCommand('copy');
      document.body.removeChild(textArea);
      alert('Ù„ÛŒÙ†Ú© Ø¯Ø¹ÙˆØª Ú©Ù¾ÛŒ Ø´Ø¯!');
    } 
  });

  // Share button
  shareRefBtn.addEventListener('click', ()=>{
    shareModal.style.display = 'flex';
  });

  // Close modal
  closeShareModal.addEventListener('click', ()=>{
    shareModal.style.display = 'none';
  });

  // Share apps functionality
  shareApps.forEach(app => {
    app.addEventListener('click', () => {
      const appType = app.dataset.app;
      shareLink(myLink, appType);
    });
  });

  // leaderboard
  leaderTable.innerHTML = '';
  FAKE_TOP10.forEach((n,i)=>{
    const tr=document.createElement('tr');
    tr.innerHTML = `<td>${i+1}</td><td>${n}</td><td>${(200 - i*10)}</td>`;
    leaderTable.appendChild(tr);
  });
  myRankEl.textContent = `#${state.myRank}`;

  renderFriendsBox();

  // if joined via ?ref (client-side info only)
  const url = new URL(location.href); const ref = url.searchParams.get('ref');
  if(ref){ pushTx({type:'info', amount:0, note:`Joined via invite ${ref}`, ts: Date.now()}); save(); renderWallet(); }
}

function shareLink(link, appType) {
  let shareUrl = '';

  switch(appType) {
    case 'whatsapp':
      shareUrl = `https://wa.me/?text=${encodeURIComponent(link)}`;
      break;
    case 'telegram':
      shareUrl = `https://t.me/share/url?url=${encodeURIComponent(link)}`;
      break;
    case 'limoo':
      // Limoo doesn't have a direct share URL, so we'll use a generic approach
      alert(`Ù„ÛŒÙ†Ú© Ø¯Ø¹ÙˆØª Ø¨Ø±Ø§ÛŒ Ø§Ø´ØªØ±Ø§Ú© Ø¯Ø± Ù„ÛŒÙ…Ùˆ: ${link}`);
      return;
    case 'copy':
      navigator.clipboard.writeText(link);
      alert('Ù„ÛŒÙ†Ú© Ø¯Ø¹ÙˆØª Ú©Ù¾ÛŒ Ø´Ø¯!');
      return;
    case 'more':
      if (navigator.share) {
        navigator.share({
          title: 'PiProtocol Ø¯Ø¹ÙˆØª Ø¨Ù‡',
          text: 'Ø¨Ù‡ PiProtocol Ø¨Ù¾ÛŒÙˆÙ†Ø¯ÛŒØ¯ Ùˆ Ø´Ø±ÙˆØ¹ Ø¨Ù‡ Ù…Ø§ÛŒÙ†ÛŒÙ†Ú¯ Ú©Ù†ÛŒØ¯!',
          url: link
        }).catch(console.error);
      } else {
        alert(`Ù„ÛŒÙ†Ú© Ø¯Ø¹ÙˆØª: ${link}`);
      }
      return;
  }

  window.open(shareUrl, '_blank');
}

function renderFriendsBox(){
  friendsInvitedEl.textContent = state.friendsInvited;
  friendsActiveEl.textContent = state.friendsActive;
}

/* ================== Tasks (Daily + Social + Manual) ================== */
const TASKS = [
  { 
    id:'daily',   
    title:'ğŸ Ù¾Ø§Ø¯Ø§Ø´ Ø±ÙˆØ²Ø§Ù†Ù‡', 
    kind:'daily', 
    reward:15, 
    url:'' 
  },
  { 
    id:'yt_subscribe',      
    title:'â–¶ï¸ Ø³Ø§Ø¨Ø³Ú©Ø±Ø§ÛŒØ¨ Ú©Ø§Ù†Ø§Ù„ ÛŒÙˆØªÛŒÙˆØ¨', 
    kind:'social', 
    reward:20, 
    url:'https://youtube.com/@YouTubeChannel',
    status: 'start' // start, checking, claim
  },
  { 
    id:'yt_like',      
    title:'ğŸ‘ Ù„Ø§ÛŒÚ© ÛŒÚ© ÙˆÛŒØ¯ÛŒÙˆ ÛŒÙˆØªÛŒÙˆØ¨', 
    kind:'daily', 
    reward:20, 
    url:'https://youtube.com/watch?v=example',
    status: 'start'
  },
  { 
    id:'yt_comment',      
    title:'ğŸ’¬ Ú¯Ø°Ø§Ø´ØªÙ† Ú©Ø§Ù…Ù†Øª Ø¯Ø± Ú©Ø§Ù†Ø§Ù„ ÛŒÙˆØªÛŒÙˆØ¨', 
    kind:'daily', 
    reward:20, 
    url:'https://youtube.com/channel/example',
    status: 'start'
  },
  { 
    id:'tg_react',      
    title:'ğŸ”¥ Ø±ÛŒ Ø§Ú©Ø´Ù† Ø¨Ù‡ ÛŒÚ© Ù¾Ø³Øª ØªÙ„Ú¯Ø±Ø§Ù…', 
    kind:'daily', 
    reward:20, 
    url:'https://t.me/channel/123',
    status: 'start'
  },
  { 
    id:'tg_comment',      
    title:'ğŸ’¬ Ú¯Ø°Ø§Ø´ØªÙ† Ú©Ø§Ù…Ù†Øª Ø¨Ù‡ ÛŒÚ© Ù¾Ø³Øª ØªÙ„Ú¯Ø±Ø§Ù…', 
    kind:'daily', 
    reward:20, 
    url:'https://t.me/channel/123',
    status: 'start'
  }
];


/* ================== ØªÙˆØ§Ø¨Ø¹ Ø¨Ø§Ø²Ù†Ø´Ø§Ù†ÛŒ Ø±ÙˆØ²Ø§Ù†Ù‡ ================== */

// Ø¨Ø±Ø±Ø³ÛŒæ˜¯å¦éœ€è¦ Ø¨Ø§Ø²Ù†Ø´Ø§Ù†ÛŒ Ø±ÙˆØ²Ø§Ù†Ù‡
function checkAndResetDailyTasks() {
  const today = new Date().toDateString();

  // Ø§Ú¯Ø± ØªØ§Ø±ÛŒØ® Ø§Ù…Ø±ÙˆØ² Ø¨Ø§ ØªØ§Ø±ÛŒØ® Ø¢Ø®Ø±ÛŒÙ† Ø¨Ø§Ø²Ù†Ø´Ø§Ù†ÛŒ Ù…ØªÙØ§ÙˆØª Ø§Ø³Øª
  if (state.lastResetDate !== today) {
    console.log('Ø¨Ø§Ø²Ù†Ø´Ø§Ù†ÛŒ ØªØ³Ú©â€ŒÙ‡Ø§ Ø¨Ø±Ø§ÛŒ Ø±ÙˆØ² Ø¬Ø¯ÛŒØ¯');
    resetDailyTasks();
    state.lastResetDate = today;
    save();
  }
}

// Ø¨Ø§Ø²Ù†Ø´Ø§Ù†ÛŒ ØªØ³Ú©â€ŒÙ‡Ø§ÛŒ Ø±ÙˆØ²Ø§Ù†Ù‡
function resetDailyTasks() {
  console.log('Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø²Ù†Ø´Ø§Ù†ÛŒ ØªØ³Ú©â€ŒÙ‡Ø§ÛŒ Ø±ÙˆØ²Ø§Ù†Ù‡...');

  // Ø­Ø°Ù ØªØ³Ú© Ø±ÙˆØ²Ø§Ù†Ù‡ Ø§Ø² completedTasks
  const dailyTaskIndex = state.completedTasks.indexOf('daily');
  if (dailyTaskIndex > -1) {
    state.completedTasks.splice(dailyTaskIndex, 1);
  }

  // Ø¨Ø§Ø²Ù†Ø´Ø§Ù†ÛŒ ÙˆØ¶Ø¹ÛŒØª ØªØ³Ú© Ø±ÙˆØ²Ø§Ù†Ù‡
  state.taskStatuses['daily'] = 'claim';

  // Ø¨Ø§Ø²Ù†Ø´Ø§Ù†ÛŒ ØªØ³Ú©â€ŒÙ‡Ø§ÛŒ Ø§Ø¬ØªÙ…Ø§Ø¹ÛŒ
  TASKS.forEach(task => {
    if (task.kind === 'social' && state.taskStatuses[task.id] === 'completed') {
      state.taskStatuses[task.id] = 'start';

      // Ø­Ø°Ù Ø§Ø² completedTasks
      const index = state.completedTasks.indexOf(task.id);
      if (index > -1) {
        state.completedTasks.splice(index, 1);
      }
    }
  });

  save();
  renderTasks();
}


function setupTasks(){
  renderTasks();
  manualMineBtn.addEventListener('click', ()=>{
    const now = Date.now();
    const remaining = state.lastManual ? (MANUAL_COOLDOWN - (now - state.lastManual)) : 0;
    if(remaining>0){
      manualCooldownEl.textContent = `Cooldown: ${Math.ceil(remaining/1000)}s`;
      return;
    }
    state.coins += MANUAL_GAIN;
    state.lastManual = now;
    manualCooldownEl.textContent = `Cooldown: ${MANUAL_COOLDOWN/1000}s`;
    pushTx({type:'earn', amount:MANUAL_GAIN, note:'Manual mining click', ts: Date.now()});
    save(); renderWallet(); updateMiningUI();

    const iv = setInterval(()=>{
      const r = MANUAL_COOLDOWN - (Date.now() - state.lastManual);
      if(r<=0){ manualCooldownEl.textContent=''; clearInterval(iv); }
      else manualCooldownEl.textContent = `Cooldown: ${Math.ceil(r/1000)}s`;
    }, 250);
  });
}

function renderTasks(){
  tasksWrap.innerHTML='';

  // Ø§ÙØ²ÙˆØ¯Ù† Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¨Ø§Ø²Ù†Ø´Ø§Ù†ÛŒ Ø¯Ø± Ø¨Ø§Ù„Ø§ÛŒ ØªØ³Ú©â€ŒÙ‡Ø§
  const resetHeader = document.createElement('div');
  resetHeader.className = 'muted';
  resetHeader.style.marginBottom = '15px';
  resetHeader.style.textAlign = 'center';
  resetHeader.style.fontSize = '12px';

  const now = new Date();
  const resetTime = new Date();
  resetTime.setHours(24, 0, 0, 0); // Ø³Ø§Ø¹Øª Û²Û´:Û°Û° (Ù†ÛŒÙ…Ù‡ Ø´Ø¨)
  const timeUntilReset = resetTime - now;
  const hours = Math.floor(timeUntilReset / (1000 * 60 * 60));
  const minutes = Math.floor((timeUntilReset % (1000 * 60 * 60)) / (1000 * 60));

  resetHeader.textContent = `Ø¨Ø§Ø²Ù†Ø´Ø§Ù†ÛŒ Ø¨Ø¹Ø¯ÛŒ: ${hours} Ø³Ø§Ø¹Øª Ùˆ ${minutes} Ø¯Ù‚ÛŒÙ‚Ù‡ Ø¯ÛŒÚ¯Ø±`;
  tasksWrap.appendChild(resetHeader);

  TASKS.forEach(t=>{
    const isDailyTask = t.id === 'daily';
    const isCompleted = state.completedTasks.includes(t.id);
    const taskStatus = isDailyTask ? (isCompleted ? 'completed' : 'claim') : (state.taskStatuses[t.id] || 'start');

    const row = document.createElement('div');
    row.className='row'; 
    row.style.margin='12px 0';
    row.style.padding='12px';
    row.style.border='1px solid var(--border)';
    row.style.borderRadius='12px';
    row.style.backgroundColor='rgba(255,255,255,0.05)';
    row.style.alignItems = 'center';

    const left = document.createElement('div'); 
    left.style.flex = '1';
    left.innerHTML = `
      <div><b>${t.title}</b></div>
      <div class="muted">+${t.reward} coins</div>
    `;

    const right = document.createElement('div');

    const actionBtn = document.createElement('button'); 
    actionBtn.className = 'btn';

    switch(taskStatus) {
      case 'start':
        actionBtn.className = 'btn btn-gold';
        actionBtn.textContent = 'Start';
        actionBtn.disabled = false;
        break;
      case 'checking':
        actionBtn.className = 'btn btn-secondary';
        actionBtn.textContent = 'Checking...';
        actionBtn.disabled = true;
        break;
      case 'claim':
        actionBtn.className = 'btn btn-success';
        actionBtn.textContent = 'Claim';
        actionBtn.disabled = false;
        break;
      case 'completed':
        actionBtn.className = 'btn btn-ghost';
        actionBtn.textContent = 'Completed';
        actionBtn.disabled = true;
        break;
    }

    actionBtn.addEventListener('click', () => {
      if (taskStatus === 'start') {
        // Ø¨Ø§Ø² Ú©Ø±Ø¯Ù† Ù„ÛŒÙ†Ú© Ø¯Ø± Ù†Ø±Ù…â€ŒØ§ÙØ²Ø§Ø± Ù…Ø±Ø¨ÙˆØ·Ù‡
        if (t.url) {
          window.open(t.url, '_blank');
        }
        handleTaskAction(t.id);
      } else if (taskStatus === 'claim') {
        claimTaskReward(t.id, t.reward, t.title);
      }
    });

    right.appendChild(actionBtn);
    row.appendChild(left); 
    row.appendChild(right);
    tasksWrap.appendChild(row);
  });
}

function handleTaskAction(taskId) {
  // ØªØºÛŒÛŒØ± ÙˆØ¶Ø¹ÛŒØª ØªØ³Ú© Ø¨Ù‡ checking
  const task = TASKS.find(t => t.id === taskId);
  if (task) {
    task.status = 'checking';

    // Ø°Ø®ÛŒØ±Ù‡ ÙˆØ¶Ø¹ÛŒØª Ø¯Ø± state
    if (!state.taskStatuses) state.taskStatuses = {};
    state.taskStatuses[taskId] = 'checking';
    save();

    // Ø±Ù†Ø¯Ø± Ù…Ø¬Ø¯Ø¯ ØªØ³Ú©â€ŒÙ‡Ø§
    renderTasks();

    // ØªÙ†Ø¸ÛŒÙ… ØªØ§ÛŒÙ…Ø± Ø¨Ø±Ø§ÛŒ ØªØºÛŒÛŒØ± ÙˆØ¶Ø¹ÛŒØª Ø¨Ù‡ claim Ø¨Ø¹Ø¯ Ø§Ø² 1 Ø¯Ù‚ÛŒÙ‚Ù‡
    setTimeout(() => {
      task.status = 'claim';
      if (state.taskStatuses) {
        state.taskStatuses[taskId] = 'claim';
      }
      save();
      renderTasks();
    }, 60000); // 1 Ø¯Ù‚ÛŒÙ‚Ù‡
  }
}

function claimTaskReward(taskId, reward, title) {
  // Ù¾Ø±Ø¯Ø§Ø®Øª Ù¾Ø§Ø¯Ø§Ø´
  state.coins += reward;
  state.completedTasks.push(taskId);

  // ØªØºÛŒÛŒØ± ÙˆØ¶Ø¹ÛŒØª ØªØ³Ú© Ø¨Ù‡ completed
  const task = TASKS.find(t => t.id === taskId);
  if (task) {
    task.status = 'completed';
  }

  if (!state.taskStatuses) state.taskStatuses = {};
  state.taskStatuses[taskId] = 'completed';

  pushTx({type:'earn', amount:reward, note:`Task: ${title}`, ts: Date.now()});
  save(); 
  renderTasks(); 
  renderWallet(); 
  updateMiningUI();
}

// Ø¯Ø± ØªØ§Ø¨Ø¹ bootØŒ ÙˆØ¶Ø¹ÛŒØª ØªØ³Ú©â€ŒÙ‡Ø§ Ø±Ø§ Ø§Ø² state Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ Ú©Ù†ÛŒØ¯
function boot(){
  updateMiningUI();
  renderWallet();
  setupFriends();
  setupTasks();
  setupProfile();
  loadNews();

  // Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ ÙˆØ¶Ø¹ÛŒØª ØªØ³Ú©â€ŒÙ‡Ø§ Ø§Ø² state
  if (state.taskStatuses) {
    TASKS.forEach(task => {
      if (state.taskStatuses[task.id]) {
        task.status = state.taskStatuses[task.id];
      }
    });
  }

  // Ø§Ú¯Ø± Ø¯Ø± Ø­Ø§Ù„ Ù…Ø§ÛŒÙ†ÛŒÙ†Ú¯ Ø¨ÙˆØ¯ØŒ ØªÛŒÚ© Ø±Ø§ Ø§Ø¯Ø§Ù…Ù‡ Ø¨Ø¯Ù‡ ÛŒØ§ Ø§Ú¯Ø± ØªÙ…Ø§Ù… Ø´Ø¯Ù‡ Ø§Ù…Ø§ Ù‡Ù†ÙˆØ² claim Ù†Ø´Ø¯Ù‡ØŒ UI Ø±Ø§ Ø¢Ù…Ø§Ø¯Ù‡ Ú©Ù†
  if(state.miningStart){
    const {remaining} = miningMetrics();
    if(remaining>0) runTick();
    else {
      // ØªØ§ÛŒÙ…Ø± ØªÙ…Ø§Ù… Ø´Ø¯Ù‡ Ø§Ù…Ø§ Ú©Ø§Ø±Ø¨Ø± Ù‡Ù†ÙˆØ² claim Ù†Ú©Ø±Ø¯Ù‡ â€” ÙÙ‚Ø· Ø¢Ù¾Ø¯ÛŒØª UI ØªØ§ Ø¯Ú©Ù…Ù‡ ÙØ¹Ø§Ù„ Ø¨Ø§Ø´Ø¯
      updateMiningUI();
    }
  }
}

/* ================== News ================== */
async function loadNews(){
  newsListEl.innerHTML = '';
  const add = (title, body)=> {
    const li = document.createElement('li');
    li.style.padding='8px 0';
    li.innerHTML = `<div><b>${title}</b></div><div class="muted">${body}</div>`;
    newsListEl.appendChild(li);
  };
  try{
    const res = await fetch(`${API_BASE}/news`,{method:'GET'});
    if(res.ok){
      const data = await res.json(); // [{title, content, published_at}]
      if(Array.isArray(data) && data.length){
        data.slice(0,6).forEach(n=> add(n.title, n.content||''));
        return;
      }
    }
    // fallback
    add('Welcome to PiNet!', 'Start mining today and earn your first coins.');
    add('Update v1.2', 'Manual mining + Daily tasks are live.');
  }catch(e){
    add('Welcome to PiNet!', 'Start mining today and earn your first coins.');
    add('Update v1.2', 'Manual mining + Daily tasks are live.');
  }
}

/* ================== Profile ================== */
function setupProfile(){
  firstNameInput.value = state.profile.first||'';
  lastNameInput.value  = state.profile.last||'';
  userIdInput.value    = state.profile.id||'';
  saveProfileBtn.addEventListener('click',()=>{
    state.profile.first = firstNameInput.value.trim();
    state.profile.last  = lastNameInput.value.trim();
    state.profile.id    = userIdInput.value.trim();
    save(); alert('Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯!');
    // Update referral link if user ID changed
    setupFriends();
  });
}

/* ================== Persistence ================== */
function load(){ try{return JSON.parse(localStorage.getItem(STORAGE_KEY));}catch(e){return null;} }
function save(){ try{localStorage.setItem(STORAGE_KEY, JSON.stringify(state));}catch(e){} }
function rid(){ return (crypto.randomUUID?crypto.randomUUID():Math.random().toString(36).slice(2)); }

/* ================== Helpers ================== */
function pushTx(tx){
  state.tx.unshift(Object.assign({id:rid(), ts: Date.now()}, tx));
  // keep length reasonable
  if(state.tx.length>200) state.tx.length=200;
}

/* ================== Boot ================== */
function boot(){
  // Ø¨Ø±Ø±Ø³ÛŒ Ùˆ Ø¨Ø§Ø²Ù†Ø´Ø§Ù†ÛŒ ØªØ³Ú©â€ŒÙ‡Ø§ÛŒ Ø±ÙˆØ²Ø§Ù†Ù‡
  checkAndResetDailyTasks();

  updateMiningUI();
  renderWallet();
  setupFriends();
  setupTasks();
  setupProfile();
  loadNews();

  // Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ø¨Ø±Ø±Ø³ÛŒ Ø¯ÙˆØ±Ù‡â€ŒØ§ÛŒ Ø¨Ø§Ø²Ù†Ø´Ø§Ù†ÛŒ (Ù‡Ø± 1 Ø¯Ù‚ÛŒÙ‚Ù‡)
  setInterval(() => {
    checkAndResetDailyTasks();
  }, 60000);

  // Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ ÙˆØ¶Ø¹ÛŒØª ØªØ³Ú©â€ŒÙ‡Ø§ Ø§Ø² state
  if (state.taskStatuses) {
    TASKS.forEach(task => {
      if (state.taskStatuses[task.id]) {
        task.status = state.taskStatuses[task.id];
      }
    });
  }

  // Ø§Ú¯Ø± Ø¯Ø± Ø­Ø§Ù„ Ù…Ø§ÛŒÙ†ÛŒÙ†Ú¯ Ø¨ÙˆØ¯ØŒ ØªÛŒÚ© Ø±Ø§ Ø§Ø¯Ø§Ù…Ù‡ Ø¨Ø¯Ù‡ ÛŒØ§ Ø§Ú¯Ø± ØªÙ…Ø§Ù… Ø´Ø¯Ù‡ Ø§Ù…Ø§ Ù‡Ù†ÙˆØ² claim Ù†Ø´Ø¯Ù‡ØŒ UI Ø±Ø§ Ø¢Ù…Ø§Ø¯Ù‡ Ú©Ù†
  if(state.miningStart){
    const {remaining} = miningMetrics();
    if(remaining>0) runTick();
    else {
      // ØªØ§ÛŒÙ…Ø± ØªÙ…Ø§Ù… Ø´Ø¯Ù‡ Ø§Ù…Ø§ Ú©Ø§Ø±Ø¨Ø± Ù‡Ù†ÙˆØ² claim Ù†Ú©Ø±Ø¯Ù‡ â€” ÙÙ‚Ø· Ø¢Ù¾Ø¯ÛŒØª UI ØªØ§ Ø¯Ú©Ù…Ù‡ ÙØ¹Ø§Ù„ Ø¨Ø§Ø´Ø¯
      updateMiningUI();
    }
  }
}
boot();

</script>
</body>
</html>